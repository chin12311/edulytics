{% extends 'main/base.html' %}

{% block content %}
<style>
    .container {
        padding: 30px 20px;
        background-color: #f8fafc;
    }

    #coordinator-header h3 {
        font-size: 2.2rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
    }

    #coordinator-header p {
        color: #4a5568;
        margin-bottom: 6px;
        font-size: 1.1rem;
    }

    .card {
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        background-color: white;
        margin-bottom: 20px;
        border: none;
        transition: transform 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
    }

    .card-body {
        padding: 20px;
    }

    .some-specific-dropdown .dropdown-toggle {
        background: linear-gradient(135deg, #576d2e, #6b8c3a);
        color: white;
        border-radius: 25px;
        padding: 10px 20px;
        font-size: 0.95rem;
        border: none;
        box-shadow: 0 2px 8px rgba(87, 109, 46, 0.3);
        transition: all 0.3s ease;
    }

    .some-specific-dropdown .dropdown-toggle:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(87, 109, 46, 0.4);
    }

    .dropdown-menu {
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        border: none;
        padding: 8px 0;
    }

    .dropdown-item {
        padding: 10px 20px;
        font-size: 1rem;
        transition: background-color 0.2s ease;
    }

    .dropdown-item:hover {
        background-color: #f7fafc;
        color: #576d2e;
    }

    .dropdown-divider {
        margin: 5px 0;
        border-color: #e2e8f0;
    }

    .overall-option {
        background: linear-gradient(135deg, #f7fafc, #edf2f7);
        border-top: 2px solid #e2e8f0;
        font-weight: 600;
        color: #2d3748 !important;
    }

    .overall-option:hover {
        background: linear-gradient(135deg, #576d2e, #6b8c3a) !important;
        color: white !important;
    }

    .section-box {
        background: white;
        display: none;
        opacity: 0;
        transition: opacity 0.4s ease-in-out;
        padding: 30px;
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        margin: 20px 0;
    }

    .section-box h3 {
        margin-bottom: 25px;
        font-size: 1.6rem;
        font-weight: 600;
        color: #2d3748;
        background: linear-gradient(135deg, #576d2e, #4a5a26);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .overall-badge {
        background: linear-gradient(135deg, #576d2e, #6b8c3a);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-left: 8px;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        align-items: start;
        max-width: 900px;
        margin: 0 auto;
    }

    .chart-container {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }

    .scores-container {
        background: #f8fafc;
        border-radius: 12px;
        padding: 25px;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }

    .score-breakdown {
        text-align: left;
    }

    .score-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #e2e8f0;
        transition: background-color 0.2s ease;
    }

    .score-item:hover {
        background-color: rgba(255,255,255,0.5);
        border-radius: 8px;
        padding: 15px 10px;
    }

    .score-item:last-child {
        border-bottom: none;
        font-weight: 700;
        font-size: 1.1rem;
        color: #2d3748;
        background: linear-gradient(135deg, #576d2e, #6b8c3a);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-top: 10px;
        padding-top: 20px;
        border-top: 2px solid #e2e8f0;
    }

    .score-category {
        font-weight: 600;
        color: #4a5568;
        font-size: 1.05rem;
    }

    .score-value {
        font-weight: 700;
        color: #2d3748;
        font-size: 1.25rem;
        background: white;
        padding: 6px 12px;
        border-radius: 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        min-width: 70px;
        text-align: center;
    }

    .score-item:last-child .score-value {
        background: linear-gradient(135deg, #576d2e, #6b8c3a);
        color: white;
        -webkit-text-fill-color: white;
        box-shadow: 0 3px 10px rgba(87, 109, 46, 0.3);
    }

    #evaluationPieChart {
        width: 100% !important;
        height: 280px !important;
    }

    .no-data-state {
        text-align: center;
        padding: 40px 20px;
        color: #718096;
    }

    .no-data-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    .explanation-box {
        background: linear-gradient(135deg, #f7fafc, #edf2f7);
        border-radius: 12px;
        padding: 25px;
        margin: 25px 0;
        border-left: 4px solid #576d2e;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .explanation-box h5 {
        color: #576d2e;
        font-weight: 600;
        margin-bottom: 15px;
        font-size: 1.25rem;
    }

    .explanation-content {
        font-size: 1.05rem;
        color: #4a5568;
        line-height: 1.6;
    }

    .explanation-content ul {
        margin: 10px 0;
        padding-left: 20px;
    }

    .explanation-content li {
        margin-bottom: 5px;
    }

    .stats-summary {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .stat-item {
        background: white;
        padding: 12px 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
        min-width: 120px;
    }

    .stat-value {
        font-size: 1.4rem;
        font-weight: 700;
        color: #576d2e;
        display: block;
    }

    .stat-label {
        font-size: 0.95rem;
        color: #718096;
        margin-top: 4px;
    }

    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .container {
            padding: 20px 15px;
        }
        
        .section-box {
            padding: 20px 15px;
        }
        
        #evaluationPieChart {
            height: 250px !important;
        }
        
        .stats-summary {
            gap: 10px;
        }
        
        .stat-item {
            min-width: 100px;
            padding: 10px 15px;
        }

        #coordinator-header h3 {
            font-size: 1.8rem;
        }

        #coordinator-header p {
            font-size: 1rem;
        }

        .score-category {
            font-size: 1rem;
        }

        .score-value {
            font-size: 1.1rem;
        }

        .section-box h3 {
            font-size: 1.4rem;
        }
    }

    @media (max-width: 480px) {
        #coordinator-header h3 {
            font-size: 1.6rem;
        }

        #coordinator-header p {
            font-size: 0.95rem;
        }
        
        .score-value {
            font-size: 1.05rem;
            min-width: 60px;
            padding: 5px 10px;
        }

        .score-category {
            font-size: 0.95rem;
        }
        
        .section-box h3 {
            font-size: 1.3rem;
        }

        .explanation-box h5 {
            font-size: 1.1rem;
        }

        .explanation-content {
            font-size: 0.95rem;
        }

        .dropdown-item {
            font-size: 0.95rem;
        }

        .stat-label {
            font-size: 0.85rem;
        }
    }
</style>

<div class="container mt-4">
    <!-- Coordinator Header -->
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="text-start" id="coordinator-header">
                <h3 class="mb-2">{{ coordinator.user.username }}</h3>   
                <p class="fs-6 mb-1">
                    {% if coordinator.institute == "IBM" %}
                        Institute of Business and Management
                    {% elif coordinator.institute == "ICSLIS" %}
                        Institute of Computing Studies and Library Information Science
                    {% elif coordinator.institute == "IEAS" %}
                        Institute of Education, Arts and Services
                    {% else %}
                        {{ coordinator.institute }}
                    {% endif %}
                </p>     
                <p class="fs-7 text-muted">{{ coordinator.role }}</p>
                {% if assigned_sections %}
                    <div class="mt-3">
                        <strong>Assigned Sections:</strong>
                        <div class="mt-2">
                            {% for assignment in assigned_sections %}
                                <span class="badge bg-success me-1 mb-1">{{ assignment.section.code }}</span>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}  
            </div>
        </div>
    </div>

    <!-- Section Dropdown -->
    <div class="mt-4">
        <div class="some-specific-dropdown">
            <button class="btn dropdown-toggle" type="button" id="sectionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                üìä Select Section
            </button>
            <ul class="dropdown-menu" aria-labelledby="sectionDropdown">
                <!-- Overall Option -->
                <li><a class="dropdown-item overall-option" href="#" data-section="overall">
                    üìà Overall Results 
                    <span class="overall-badge">All Sections</span>
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Individual Sections -->
                {% for assignment in assigned_sections %}
                    <li><a class="dropdown-item section-item" 
                        data-section="{{ assignment.section.id }}" 
                        data-section-display="{{ assignment.section }}" 
                        href="#">
                        üìö {{ assignment.section }}
                    </a></li>
                {% empty %}
                    <li><a class="dropdown-item text-muted" href="#">No sections assigned</a></li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Section Results Container -->
    <div class="section-box mt-4">
        <h3 id="sectionTitle">Select a section to view evaluation results</h3>
        
        <!-- Overall Stats Summary (Only shown for overall view) -->
        <div id="overallStats" class="stats-summary" style="display: none;">
            <div class="stat-item">
                <span class="stat-value" id="totalSections">0</span>
                <span class="stat-label">Total Sections</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="sectionsWithData">0</span>
                <span class="stat-label">Sections with Data</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="totalEvaluations">0</span>
                <span class="stat-label">Total Evaluations</span>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="chart-container">
                <canvas id="evaluationPieChart"></canvas>
            </div>
            
            <div id="scoreDetails" class="score-breakdown" style="display: none;">
                <div class="score-item">
                    <span class="score-category">Mastery of Subject Matter</span>
                    <span class="score-value" id="scoreA">0%</span>
                </div>
                <div class="score-item">
                    <span class="score-category">Classroom Management</span>
                    <span class="score-value" id="scoreB">0%</span>
                </div>
                <div class="score-item">
                    <span class="score-category">Compliance to policies</span>
                    <span class="score-value" id="scoreC">0%</span>
                </div>
                <div class="score-item">
                    <span class="score-category">Personality</span>
                    <span class="score-value" id="scoreD">0%</span>
                </div>
                <div class="score-item">
                    <span>Total Score</span>
                    <span class="score-value" id="totalScore">0%</span>
                </div>
            </div>
                
            <div id="noDataMessage" class="no-data-state" style="display: none;">
                <div>üìä</div>
                <p style="color: #718096; font-size: 1rem; margin: 10px 0 0 0;">
                    No evaluation data available for this section yet.
                </p>
            </div>
        </div>
    </div>

    <!-- Explanation Box -->
    <div class="explanation-box" style="display: none;" id="explanationBox">
        <h5>üìù How Evaluation Scores Are Calculated</h5>
        <div class="explanation-content">
            <p>The evaluation is divided into four weighted categories:</p>
            <ul>
                <li><strong>Mastery of Subject Matter</strong>: Questions 1-4 (35% weight)</li>
                <li><strong>Classroom Management</strong>: Questions 5-8 (25% weight)</li>
                <li><strong>Compliance to Policies</strong>: Questions 9-12 (20% weight)</li>
                <li><strong>Personality</strong>: Questions 13-15 (20% weight)</li>
            </ul>
            <p>Responses are rated on a 5-point scale (5=Outstanding, 1=Poor) and converted to percentages based on category weights.</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let chart = null;
    
    // Get data from Django template
    const sectionScores = JSON.parse('{{ section_scores_json|escapejs }}');
    const sectionMap = JSON.parse('{{ section_map_json|escapejs }}');
    
    console.log("Section Scores:", sectionScores);
    console.log("Section Map:", sectionMap);

    function calculateOverallResults() {
        console.log("Calculating overall results...");
        
        let totalSections = 0;
        let sectionsWithData = 0;
        let totalEvaluations = 0;
        
        // Initialize arrays to accumulate scores
        let categoryScoresSum = [0, 0, 0, 0]; // For 4 categories
        let totalPercentageSum = 0;
        
        // Iterate through all sections
        for (const [sectionCode, sectionData] of Object.entries(sectionScores)) {
            totalSections++;
            
            if (sectionData && sectionData.has_data) {
                sectionsWithData++;
                totalEvaluations += sectionData.evaluation_count || 0;
                
                // Accumulate category scores
                for (let i = 0; i < 4; i++) {
                    categoryScoresSum[i] += sectionData.category_scores[i] || 0;
                }
                
                // Accumulate total percentage
                totalPercentageSum += sectionData.total_percentage || 0;
            }
        }
        
        // Calculate averages
        const averageCategoryScores = sectionsWithData > 0 
            ? categoryScoresSum.map(score => score / sectionsWithData)
            : [0, 0, 0, 0];
            
        const averageTotalPercentage = sectionsWithData > 0 
            ? totalPercentageSum / sectionsWithData 
            : 0;
        
        return {
            has_data: sectionsWithData > 0,
            total_sections: totalSections,
            sections_with_data: sectionsWithData,
            total_evaluations: totalEvaluations,
            category_scores: averageCategoryScores,
            total_percentage: averageTotalPercentage
        };
    }

    function renderPieChart(sectionId) {
        console.log("Rendering chart for:", sectionId);
        
        const ctx = document.getElementById('evaluationPieChart').getContext('2d');
        
        // Destroy previous chart
        if (chart) {
            chart.destroy();
        }

        let sectionData;
        
        if (sectionId === 'overall') {
            // Calculate overall results
            sectionData = calculateOverallResults();
            console.log("Overall data:", sectionData);
            
            // Show overall stats
            document.getElementById('overallStats').style.display = 'flex';
            document.getElementById('totalSections').textContent = sectionData.total_sections;
            document.getElementById('sectionsWithData').textContent = sectionData.sections_with_data;
            document.getElementById('totalEvaluations').textContent = sectionData.total_evaluations;
        } else {
            // Individual section
            const sectionCode = sectionMap[sectionId];
            sectionData = sectionScores[sectionCode];
            console.log("Individual section data:", sectionData);
            
            // Hide overall stats
            document.getElementById('overallStats').style.display = 'none';
        }

        if (sectionData && sectionData.has_data) {
            console.log("Has data, rendering chart");
            renderChartWithData(ctx, sectionData, sectionId === 'overall');
        } else {
            console.log("No data available");
            showNoData();
        }
    }

    function renderChartWithData(ctx, sectionData, isOverall = false) {
        const categoryScores = sectionData.category_scores;
        const totalPercentage = sectionData.total_percentage;

        console.log("Rendering with scores:", categoryScores, "Total:", totalPercentage);

        // Update score details for ALL 4 CATEGORIES
        document.getElementById('scoreA').textContent = categoryScores[0].toFixed(1) + '%';
        document.getElementById('scoreB').textContent = categoryScores[1].toFixed(1) + '%';
        document.getElementById('scoreC').textContent = categoryScores[2].toFixed(1) + '%';
        document.getElementById('scoreD').textContent = categoryScores[3].toFixed(1) + '%';
        document.getElementById('totalScore').textContent = totalPercentage.toFixed(1) + '%';

        // Show elements
        document.getElementById('scoreDetails').style.display = 'block';
        document.getElementById('noDataMessage').style.display = 'none';
        document.getElementById('explanationBox').style.display = 'block';

        // Chart labels based on whether it's overall or individual
        const labels = isOverall 
            ? ['Overall Subject Mastery', 'Overall Classroom Management', 'Overall Compliance', 'Overall Personality']
            : ['Subject Mastery', 'Classroom Management', 'Compliance to Policies', 'Personality'];

        // Create enhanced chart with 4 CATEGORIES
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: categoryScores,
                    backgroundColor: [
                        'rgba(87, 109, 46, 0.8)',
                        'rgba(106, 140, 58, 0.8)',
                        'rgba(135, 171, 70, 0.8)',
                        'rgba(164, 202, 82, 0.8)'
                    ],
                    borderColor: [
                        'rgba(87, 109, 46, 1)',
                        'rgba(106, 140, 58, 1)',
                        'rgba(135, 171, 70, 1)',
                        'rgba(164, 202, 82, 1)'
                    ],
                    borderWidth: 2,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: 11,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(45, 55, 72, 0.9)',
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw.toFixed(1)}%`;
                            }
                        }
                    }
                },
                animation: {
                    animateScale: true,
                    animateRotate: true
                }
            }
        });
        
        console.log("Chart rendered successfully!");
    }

    function showNoData() {
        document.getElementById('scoreDetails').style.display = 'none';
        document.getElementById('noDataMessage').style.display = 'block';
        document.getElementById('explanationBox').style.display = 'none';
        document.getElementById('overallStats').style.display = 'none';
    }

    // Section dropdown event listeners
    document.querySelectorAll('.section-item, .overall-option').forEach(item => {
        item.addEventListener('click', function (e) {
            e.preventDefault();
            
            const sectionId = this.getAttribute('data-section');
            const displayName = this.getAttribute('data-section-display') || 'Overall Results';
            
            console.log("Clicked:", sectionId, "Display:", displayName);
            
            // Update dropdown text
            if (sectionId === 'overall') {
                document.getElementById('sectionDropdown').textContent = 'üìà Overall Results';
            } else {
                document.getElementById('sectionDropdown').textContent = 'üìö ' + displayName;
            }
            
            document.getElementById('sectionTitle').textContent = displayName + ' - Evaluation Results';

            const sectionBox = document.querySelector('.section-box');
            sectionBox.style.opacity = '0';
            
            setTimeout(() => {
                sectionBox.style.display = 'block';
                renderPieChart(sectionId);
                setTimeout(() => {
                    sectionBox.style.opacity = '1';
                }, 10);
            }, 300);
        });
    });

    // Initialize - click overall option first if available
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Page loaded, checking for sections...");
        const overallOption = document.querySelector('.overall-option');
        if (overallOption) {
            console.log("Clicking overall option...");
            overallOption.click();
        } else {
            console.log("No overall option available");
            const firstSection = document.querySelector('.section-item');
            if (firstSection) {
                firstSection.click();
            } else {
                showNoData();
            }
        }
    });
</script>

{% endblock %}