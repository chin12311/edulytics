{% extends 'main/base.html' %}
{% load static %}

{% block title %} Register {% endblock %}

{% block body_style %} 
style="background-image: url('{% static 'img/phoenix-background.png' %}'); 
        background-repeat: no-repeat; 
        background-size: cover; 
        background-position: center; 
        min-height: 100vh;" 
{% endblock %}

{% block content %}
<style>
    .custom-input-width {
        width: 100%;
        margin: 0 auto;
        border-radius: 20px;
        padding: 10px 20px;
    }

    .form-card {
        background: rgba(255, 255, 255, 0.8);
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        margin-top: 50px;
        opacity: 0;
        animation: fadeIn 0.5s ease-out forwards;
    }

    @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }

    h2, h3 { font-family: 'Arial', sans-serif; font-weight: 600; color: #47682c; margin-bottom: 40px; }
    label { font-weight: bold; color: #47682c; margin-bottom: 5px; }
    .form-control { border-radius: 20px; padding: 10px; border: 1px solid #ddd; transition: all 0.3s ease; }
    .form-control:focus { border-color: #47682c; box-shadow: 0 0 5px rgba(71,104,44,0.3); }
    .btn-success { background-color: #47682c; border: none; color: white; border-radius: 20px; padding: 10px 20px; font-weight: bold; width: 100%; transition: all 0.3s ease; }
    .btn-success:hover { background-color: #3a5a29; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .text-center { text-align: center; }
    .mb-4 { margin-bottom: 25px; }
    .form-group { margin-bottom: 20px; }

    /* Success Popup Styles */
    .success-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        z-index: 1000;
        text-align: center;
        display: none;
        animation: popIn 0.5s ease-out forwards;
    }

    @keyframes popIn {
        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    .success-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 999;
        display: none;
    }

    .success-icon {
        font-size: 48px;
        color: #47682c;
        margin-bottom: 15px;
    }

    .success-popup h3 {
        color: #47682c;
        margin-bottom: 15px;
    }

    .success-popup button {
        background-color: #47682c;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 10px;
    }

    .success-popup button:hover {
        background-color: #3a5a29;
    }

    /* Register container - override main-content for proper centering */
    #mainContent.main-content {
        padding: 0;
        margin-left: 0;
        transition: margin-left 0.3s ease-in-out;
    }

    #mainContent.main-content.shift {
        margin-left: 250px;
    }

    .register-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        width: 100%;
        padding: 20px;
    }

    .register-wrapper:last-child {
        min-height: auto;
        padding: 60px 20px;
    }

    @media (max-width: 768px) {
        .custom-input-width { width: 90%; }
        .form-card { padding: 20px; }
        .success-popup { width: 90%; margin: 0 auto; }
        
        #mainContent.main-content.shift {
            margin-left: 0;
        }
    }
</style>

<!-- Success Popup -->
<div class="success-popup-overlay" id="successOverlay"></div>
<div class="success-popup" id="successPopup">
    <div class="success-icon">‚úì</div>
    <h3>Account Created Successfully!</h3>
    <p>Your account has been created successfully.</p>
    <button onclick="closeSuccessPopup()">Continue</button>
</div>

<div class="main-content" id="mainContent">
    <div class="register-wrapper">
        <div class="form-card col-md-6 col-12">
        <h2 class="text-center">Create an Account</h2>

        <!-- Display form errors at the top -->
        {% if form.errors %}
            <div class="alert alert-danger">
                <strong>Please fix the following errors:</strong>
                <ul>
                {% for field in form %}
                    {% for error in field.errors %}
                        <li>{{ field.label }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
            </div>
        {% endif %}

        <form method="POST" id="registerForm">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ next_url }}">

            <!-- Display Name (with spaces) -->
            <div class="form-group">
                <label for="id_display_name">Full Name:</label>
                <input type="text" name="display_name" id="id_display_name" 
                       value="{{ form.display_name.value|default:'' }}" 
                       class="form-control mb-3 custom-input-width text-center" 
                       placeholder="Enter your full name" required>
                
            </div>
            
            <!-- Email -->
            <div class="form-group">
                <label for="id_email">Email:</label>
                <input type="email" name="email" id="id_email" 
                       value="{{ form.email.value|default:'' }}" 
                       class="form-control mb-3 custom-input-width text-center" 
                       placeholder="your@email.com" required>
            </div>
            
            <!-- Role -->
            <div class="form-group">
                <label for="id_role">Role:</label>
                <select name="role" id="id_role" class="form-control mb-3 custom-input-width text-center" required>
                    <option value="">Select Role</option>
                    <option value="Student" {% if form.role.value == "Student" %}selected{% endif %}>Student</option>
                    <option value="Dean" {% if form.role.value == "Dean" %}selected{% endif %}>Dean</option>
                    <option value="Faculty" {% if form.role.value == "Faculty" %}selected{% endif %}>Faculty</option>
                    <option value="Coordinator" {% if form.role.value == "Coordinator" %}selected{% endif %}>Coordinator</option>
                </select>
            </div>
            
            <!-- Student Fields -->
            <div id="student-fields" style="display: none;">
                <div class="form-group">
                    <label for="id_studentNumber">Student Number:</label>
                    <input type="text" name="studentNumber" id="id_studentNumber" 
                           value="{{ form.studentNumber.value|default:'' }}" 
                           class="form-control mb-3 custom-input-width text-center" 
                           placeholder="e.g., 21-1766" maxlength="7" pattern="[0-9\-]*" inputmode="decimal">
                    <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        var studentNumberInput = document.getElementById('id_studentNumber');
                        if (studentNumberInput) {
                            // Auto-format student number with hyphen (XX-XXXX)
                            studentNumberInput.addEventListener('input', function(e) {
                                // Remove all non-numeric characters first
                                let value = this.value.replace(/[^0-9]/g, '');
                                
                                // Auto-format: add hyphen after 2 digits
                                if (value.length >= 2) {
                                    value = value.substring(0, 2) + '-' + value.substring(2, 6);
                                }
                                
                                // Limit to 7 characters (XX-XXXX)
                                this.value = value.substring(0, 7);
                            });
                            
                            // Prevent pasting non-numeric content
                            studentNumberInput.addEventListener('paste', function(e) {
                                e.preventDefault();
                                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                                let numericOnly = pastedText.replace(/[^0-9]/g, '');
                                
                                // Auto-format pasted content
                                if (numericOnly.length >= 2) {
                                    numericOnly = numericOnly.substring(0, 2) + '-' + numericOnly.substring(2, 6);
                                }
                                
                                this.value = numericOnly.substring(0, 7);
                            });
                            
                            // Block keyboard input of non-numeric characters
                            studentNumberInput.addEventListener('keypress', function(e) {
                                const char = String.fromCharCode(e.which);
                                if (!/[0-9]/.test(char)) {
                                    e.preventDefault();
                                }
                            });
                        }
                    });
                    </script>
                </div>
                
                <div class="form-group">
                    <label for="id_course">Course:</label>
                    <select name="course" id="id_course" class="form-control mb-3 custom-input-width text-center">
                        <option value="">Select Course</option>
                        <option value="BSCS" {% if form.course.value == "BSCS" %}selected{% endif %}>Bachelor of Science in Computer Science</option>
                        <option value="BSIS" {% if form.course.value == "BSIS" %}selected{% endif %}>Bachelor of Science in Information Systems</option>
                        <option value="ACT" {% if form.course.value == "ACT" %}selected{% endif %}>Associate in Computer Technology</option>
                        <option value="BLIS" {% if form.course.value == "BLIS" %}selected{% endif %}>Bachelor of Library and Information Science</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="id_section">Section:</label>
                    <select name="section" id="id_section" class="form-control mb-3 custom-input-width text-center">
                        <option value="">Select Section</option>
                        {% for section in form.fields.section.queryset %}
                            <option value="{{ section.id }}" {% if form.section.value == section.id %}selected{% endif %}>{{ section }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- Staff Fields -->
            <div id="staff-fields" style="display: none;">
                <div class="form-group">
                    <label for="id_institute">Institute:</label>
                    <select name="institute" id="id_institute" class="form-control mb-3 custom-input-width text-center">
                        <option value="">Select Institute</option>
                        <option value="IBM" {% if form.institute.value == "IBM" %}selected{% endif %}>Institute of Business and Management</option>
                        <option value="ICSLIS" {% if form.institute.value == "ICSLIS" %}selected{% endif %}>Institute of Computing Studies and Library Information Science</option>
                        <option value="IEAS" {% if form.institute.value == "IEAS" %}selected{% endif %}>Institute of Education, Arts and Services</option>
                    </select>
                </div>
            </div>
            
            <!-- Passwords -->
            <div class="form-group">
                <label for="id_password1">Password:</label>
                <input type="password" name="password1" id="id_password1" 
                       class="form-control mb-3 custom-input-width text-center" 
                       placeholder="Enter password" required>
            </div>
            
            <div class="form-group">
                <label for="id_password2">Confirm Password:</label>
                <input type="password" name="password2" id="id_password2" 
                       class="form-control mb-3 custom-input-width text-center" 
                       placeholder="Confirm password" required>
            </div>
            
            <button type="submit" class="btn btn-success w-100 fw-bold">Create Account</button>
        </form>
    </div>
    </div>

<!-- Account Import/Export Section -->
<div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%); border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <h3 style="margin-bottom: 20px; color: #6A1B9A; display: flex; align-items: center; gap: 10px; font-size: 1.1rem;">
        <span style="font-size: 1.4rem;">üìä</span>
        Account Import/Export
    </h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
        <!-- Export Card -->
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(106, 27, 154, 0.15); border-left: 4px solid #8E24AA;">
            <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                <span style="font-size: 1.8rem; flex-shrink: 0;">üì§</span>
                <div>
                    <strong style="color: #6A1B9A; display: block; margin-bottom: 5px; font-size: 0.95rem;">Export Accounts</strong>
                    <p style="color: #666; font-size: 0.85rem; margin: 0; line-height: 1.5;">Download all accounts as Excel file for backup or editing</p>
                </div>
            </div>
            <a href="{% url 'export_accounts' %}" 
               class="btn btn-sm"
               style="background: linear-gradient(135deg, #8E24AA 0%, #6A1B9A 100%); 
                      color: white; 
                      border: none; 
                      padding: 8px 16px; 
                      border-radius: 6px; 
                      text-decoration: none; 
                      display: inline-flex; 
                      align-items: center; 
                      gap: 6px; 
                      font-size: 0.85rem;
                      transition: all 0.3s ease;
                      box-shadow: 0 2px 4px rgba(142, 36, 170, 0.2);"
               onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(142, 36, 170, 0.3)';"
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(142, 36, 170, 0.2)';">
                <span>üì•</span> Download Excel
            </a>
        </div>

        <!-- Import Card -->
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(106, 27, 154, 0.15); border-left: 4px solid #7B1FA2;">
            <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                <span style="font-size: 1.8rem; flex-shrink: 0;">üì•</span>
                <div>
                    <strong style="color: #6A1B9A; display: block; margin-bottom: 5px; font-size: 0.95rem;">Import Accounts</strong>
                    <p style="color: #666; font-size: 0.85rem; margin: 0; line-height: 1.5;">Upload Excel file to create or update multiple accounts</p>
                </div>
            </div>
            <a href="{% url 'import_accounts' %}" 
               class="btn btn-sm"
               style="background: linear-gradient(135deg, #7B1FA2 0%, #6A1B9A 100%); 
                      color: white; 
                      border: none; 
                      padding: 8px 16px; 
                      border-radius: 6px; 
                      text-decoration: none; 
                      display: inline-flex; 
                      align-items: center; 
                      gap: 6px; 
                      font-size: 0.85rem;
                      transition: all 0.3s ease;
                      box-shadow: 0 2px 4px rgba(123, 31, 162, 0.2);"
               onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(123, 31, 162, 0.3)';"
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(123, 31, 162, 0.2)';">
                <span>üì§</span> Upload Excel
            </a>
        </div>
    </div>

    <!-- Info Section -->
    <div style="background: linear-gradient(135deg, #FFF8E1 0%, #FFF9C4 100%); padding: 20px; border-radius: 10px; border-left: 4px solid #FBC02D; box-shadow: 0 2px 8px rgba(251, 192, 45, 0.15); margin-top: 15px;">
        <div style="display: flex; align-items: flex-start; gap: 12px;">
            <span style="font-size: 1.3rem; flex-shrink: 0; margin-top: 2px;">‚ÑπÔ∏è</span>
            <div>
                <strong style="color: #F57F17; display: block; margin-bottom: 10px; font-size: 0.95rem;">Features:</strong>
                <ul style="margin: 0; padding-left: 20px; color: #E65100; font-size: 0.85rem; line-height: 1.6;">
                    <li>Automatically sorted by role with color coding</li>
                    <li>Create new or update existing accounts</li>
                    <li>Admin-only access for security</li>
                </ul>
            </div>
        </div>
    </div>
</div>

</div>

<script>
// Show/hide fields based on role selection
document.addEventListener('DOMContentLoaded', function() {
    const roleField = document.getElementById('id_role');
    const studentFields = document.getElementById('student-fields');
    const staffFields = document.getElementById('staff-fields');
    
    function toggleFields() {
        const role = roleField.value;
        
        if (role === 'Student') {
            studentFields.style.display = 'block';
            staffFields.style.display = 'none';
            
            // Make student fields required
            document.getElementById('id_studentNumber').required = true;
            document.getElementById('id_course').required = true;
            document.getElementById('id_section').required = true;
            document.getElementById('id_institute').required = false;
        } else if (['Dean', 'Faculty', 'Coordinator'].includes(role)) {
            studentFields.style.display = 'none';
            staffFields.style.display = 'block';
            
            // Make staff fields required
            document.getElementById('id_studentNumber').required = false;
            document.getElementById('id_course').required = false;
            document.getElementById('id_section').required = false;
            document.getElementById('id_institute').required = true;
        } else {
            studentFields.style.display = 'none';
            staffFields.style.display = 'none';
            
            // Remove requirements when no role selected
            document.getElementById('id_studentNumber').required = false;
            document.getElementById('id_course').required = false;
            document.getElementById('id_section').required = false;
            document.getElementById('id_institute').required = false;
        }
    }
    
    roleField.addEventListener('change', toggleFields);
    toggleFields(); // Initialize on page load
});

// Success Popup Functions
function showSuccessPopup() {
    document.getElementById('successPopup').style.display = 'block';
    document.getElementById('successOverlay').style.display = 'block';
}

function closeSuccessPopup() {
    document.getElementById('successPopup').style.display = 'none';
    document.getElementById('successOverlay').style.display = 'none';
    
    // Redirect to login or next URL
    const nextUrlInput = document.querySelector('input[name="next"]');
    if (nextUrlInput && nextUrlInput.value) {
        window.location.href = nextUrlInput.value;
    } else {
        window.location.href = '/login/';
    }
}

// Close popup when clicking outside
document.getElementById('successOverlay').addEventListener('click', closeSuccessPopup);

// Show success popup if account was created successfully (you can trigger this from your view)
{% if success %}
document.addEventListener('DOMContentLoaded', function() {
    showSuccessPopup();
});
{% endif %}

</script>
{% endblock %}