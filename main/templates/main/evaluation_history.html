{% extends 'main/base.html' %}

{% block title %}Evaluation History{% endblock %}{% block content %}
<style>
    .period-card {
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
        background: linear-gradient(135deg, #f9f9f9, #ffffff);
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .period-card:hover {
        border-color: #47682c;
        box-shadow: 0 4px 16px rgba(71, 104, 44, 0.15);
        transform: translateY(-2px);
    }
    
    .period-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 16px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 16px;
    }
    
    .period-title {
        color: #47682c;
        font-weight: 600;
        margin: 0;
        font-size: 1.3rem;
    }
    
    .period-dates {
        display: flex;
        gap: 20px;
        margin-top: 8px;
        font-size: 0.95rem;
        color: #666;
    }
    
    .period-dates i {
        color: #47682c;
        margin-right: 6px;
        width: 18px;
    }
    
    .score-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 1.1rem;
        text-align: center;
        min-width: 90px;
    }
    
    .score-excellent {
        background: linear-gradient(135deg, #47682c, #5a8537);
        color: white;
    }
    
    .score-good {
        background: linear-gradient(135deg, #5a8537, #7da345);
        color: white;
    }
    
    .score-average {
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: white;
    }
    
    .score-poor {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
    }
    
    .period-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .info-box {
        background: #f5f5f5;
        padding: 16px;
        border-radius: 8px;
        border-left: 4px solid #47682c;
    }
    
    .info-box-title {
        color: #666;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        font-weight: 600;
    }
    
    .info-box-value {
        color: #2c3e50;
        font-size: 1.4rem;
        font-weight: 600;
    }
    
    .category-scores {
        background: #f5f5f5;
        padding: 16px;
        border-radius: 8px;
        margin-top: 20px;
    }
    
    .category-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .category-item:last-child {
        border-bottom: none;
    }
    
    .category-label {
        font-weight: 500;
        color: #34495e;
    }
    
    .category-bar {
        flex: 1;
        height: 8px;
        background: #ddd;
        border-radius: 4px;
        margin: 0 12px;
        overflow: hidden;
    }
    
    .category-fill {
        height: 100%;
        background: linear-gradient(90deg, #47682c, #5a8537);
        transition: width 0.4s ease;
    }
    
    .category-score {
        min-width: 50px;
        text-align: right;
        font-weight: 600;
        color: #47682c;
    }
    
    .recommendations-section {
        background: #f0f7e8;
        padding: 16px;
        border-radius: 8px;
        border-left: 4px solid #47682c;
        margin-top: 16px;
    }
    
    .recommendations-title {
        color: #47682c;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .recommendation-item {
        background: white;
        padding: 12px;
        border-radius: 6px;
        margin: 8px 0;
        border-left: 3px solid #7da345;
        font-size: 0.95rem;
        color: #34495e;
    }
    
    .comments-section {
        background: #e8f4f8;
        padding: 16px;
        border-radius: 8px;
        border-left: 4px solid #3498db;
        margin-top: 16px;
    }
    
    .comments-title {
        color: #2980b9;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .comment-item {
        background: white;
        padding: 12px;
        border-radius: 6px;
        margin: 8px 0;
        border-left: 3px solid #3498db;
        font-size: 0.95rem;
        color: #34495e;
        font-style: italic;
    }
    
    .no-history {
        text-align: center;
        padding: 60px 20px;
    }
    
    .no-history-icon {
        font-size: 4rem;
        color: #ccc;
        margin-bottom: 20px;
    }
    
    .timeline {
        position: relative;
        padding: 20px 0;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 20px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(180deg, #47682c, #e0e0e0);
    }
    
    .timeline-item {
        margin-left: 60px;
        position: relative;
        margin-bottom: 30px;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -40px;
        top: 8px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #47682c;
        border: 3px solid #f9f9f9;
        box-shadow: 0 0 0 2px #47682c;
    }
    
    /* Dropdown styles for period header */
    .period-header .dropdown .btn-sm {
        background: linear-gradient(135deg, #47682c, #5a8537);
        color: white;
        border: none;
        padding: 6px 12px;
        font-size: 0.9rem;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    
    .period-header .dropdown .btn-sm:hover {
        background: linear-gradient(135deg, #3a5a29, #4a7230);
        transform: translateY(-1px);
    }
    
    .period-header .dropdown-menu {
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .period-result-option {
        transition: all 0.2s ease;
    }
    
    .period-result-option:hover {
        background-color: #e8f5e8;
        color: #47682c !important;
        transform: translateX(4px);
    }
</style>

<div class="container mt-4 mb-5">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="card-title h3 mb-2">
                                <i class="bi bi-clock-history me-2"></i>Evaluation History
                            </h1>
                            <p class="text-muted mb-0">Your past evaluation periods and results</p>
                        </div>
                        <div class="badge {% if evaluation_period_active %}bg-info{% else %}bg-success{% endif %}">
                            <i class="bi bi-{% if evaluation_period_active %}play-circle{% else %}archive{% endif %} me-1"></i>
                            {% if evaluation_period_active %}Current Period Active{% else %}Past Results{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evaluation Periods Timeline -->
            {% if evaluation_history %}
                <div class="timeline">
                    {% for period in evaluation_history %}
                        <div class="timeline-item">
                            <div class="period-card">
                                <!-- Period Header with Title and Score -->
                                <div class="period-header">
                                    <div style="flex: 1;">
                                        <h4 class="period-title">
                                            {{ period.period_name }}
                                        </h4>
                                        <div class="period-dates">
                                            <div>
                                                <i class="fas fa-calendar-alt"></i>
                                                <strong>Evaluation Date:</strong> {{ period.date|date:"F d, Y" }} at {{ period.date|time:"g:i A" }}
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 12px; align-items: flex-start;">
                                        <!-- View Results Dropdown -->
                                        <div class="dropdown">
                                            <button class="btn btn-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                üìä Results
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li><a class="dropdown-item period-result-option" href="javascript:void(0);" data-result-type="overall">
                                                    üìà Overall Results
                                                </a></li>
                                                <li><a class="dropdown-item period-result-option" href="javascript:void(0);" data-result-type="peer">
                                                    üë• Peer Evaluation Results
                                                </a></li>
                                                {% if user_sections %}
                                                <li><hr class="dropdown-divider"></li>
                                                {% for section in user_sections %}
                                                <li><a class="dropdown-item period-result-option" href="javascript:void(0);" data-result-type="section" data-section-id="{{ section.id }}" data-section-name="{{ section.name }}">
                                                    üìö {{ section.name }}
                                                </a></li>
                                                {% endfor %}
                                                {% endif %}
                                            </ul>
                                        </div>
                                        <div class="score-badge {% if period.overall_percentage >= 90 %}score-excellent{% elif period.overall_percentage >= 80 %}score-good{% elif period.overall_percentage >= 70 %}score-average{% else %}score-poor{% endif %}">
                                            {{ period.overall_percentage|floatformat:1 }}%
                                        </div>
                                    </div>
                                </div>

                                <!-- Period Content Grid -->
                                <div class="period-content">
                                    <!-- Overall Rating -->
                                    <div class="info-box">
                                        <div class="info-box-title">Overall Rating</div>
                                        <div class="info-box-value" style="color: #47682c;">
                                            {{ period.average_rating|floatformat:2 }} / 5.0
                                        </div>
                                        <small class="text-muted">
                                            {% if period.average_rating >= 4.5 %}Outstanding{% elif period.average_rating >= 4 %}Very Satisfactory{% elif period.average_rating >= 3 %}Satisfactory{% else %}Needs Improvement{% endif %}
                                        </small>
                                    </div>

                                    <!-- Total Responses -->
                                    <div class="info-box">
                                        <div class="info-box-title">Evaluators</div>
                                        <div class="info-box-value" style="color: #47682c;">
                                            {{ period.total_responses }}
                                        </div>
                                        <small class="text-muted">Total evaluations received</small>
                                    </div>

                                    <!-- Evaluation Period Status -->
                                    <div class="info-box">
                                        <div class="info-box-title">Period</div>
                                        <div class="info-box-value" style="color: #47682c; font-size: 1rem;">
                                            {{ period.section }}
                                        </div>
                                        <small class="text-muted">{{ period.source }}</small>
                                    </div>
                                </div>

                                <!-- Category Scores -->
                                <div class="category-scores">
                                    <h6 style="color: #34495e; font-weight: 600; margin-bottom: 12px;">Category Breakdown</h6>
                                    
                                    <!-- Category A -->
                                    <div class="category-item">
                                        <span class="category-label">üìö Subject Mastery</span>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: {% widthratio period.category_scores.0 35 100 %}%;"></div>
                                        </div>
                                        <span class="category-score">{{ period.category_scores.0|floatformat:1 }}%</span>
                                    </div>

                                    <!-- Category B -->
                                    <div class="category-item">
                                        <span class="category-label">üè´ Classroom Management</span>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: {% widthratio period.category_scores.1 25 100 %}%;"></div>
                                        </div>
                                        <span class="category-score">{{ period.category_scores.1|floatformat:1 }}%</span>
                                    </div>

                                    <!-- Category C -->
                                    <div class="category-item">
                                        <span class="category-label">‚úÖ Compliance</span>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: {% widthratio period.category_scores.2 20 100 %}%;"></div>
                                        </div>
                                        <span class="category-score">{{ period.category_scores.2|floatformat:1 }}%</span>
                                    </div>

                                    <!-- Category D -->
                                    <div class="category-item">
                                        <span class="category-label">üòä Personality</span>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: {% widthratio period.category_scores.3 20 100 %}%;"></div>
                                        </div>
                                        <span class="category-score">{{ period.category_scores.3|floatformat:1 }}%</span>
                                    </div>
                                </div>

                                <!-- AI Recommendations -->
                                {% if period.recommendations %}
                                <div class="recommendations-section">
                                    <div class="recommendations-title">
                                        <i class="fas fa-lightbulb"></i>
                                        AI Recommendations
                                    </div>
                                    {% for rec in period.recommendations %}
                                        <div class="recommendation-item">
                                            <strong>{{ rec.title }}</strong><br>
                                            <small>{{ rec.description }}</small>
                                        </div>
                                    {% empty %}
                                        <div class="recommendation-item">
                                            No recommendations available for this period.
                                        </div>
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <!-- Student Comments -->
                                {% if period.comments %}
                                <div class="comments-section">
                                    <div class="comments-title">
                                        <i class="fas fa-comments"></i>
                                        Student Feedback
                                    </div>
                                    {% for comment in period.comments %}
                                        <div class="comment-item">
                                            "{{ comment }}"
                                        </div>
                                    {% empty %}
                                        <div class="comment-item">
                                            No student comments for this period.
                                        </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Summary Statistics -->
                <div class="row mt-5">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-2">Total Evaluations</h6>
                                <h3 class="text-success">{{ total_evaluations }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-2">Average Score</h6>
                                <h3 class="text-success">{{ average_percentage|floatformat:1 }}%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-2">Latest Score</h6>
                                <h3 class="text-success">{{ latest_score|floatformat:1 }}%</h3>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- No History Message -->
                <div class="card">
                    <div class="card-body">
                        <div class="no-history">
                            <div class="no-history-icon">üìä</div>
                            <h4 class="text-muted">No Evaluation History</h4>
                            <p class="text-muted">
                                You currently have no past evaluation periods recorded.<br>
                                Results will appear here once a new evaluation period is released after your current evaluation completes.
                            </p>
                            <p style="font-size: 0.9rem; color: #999; margin-top: 20px;">
                                <i class="fas fa-info-circle"></i>
                                Note: Current evaluation results are accessible from your profile settings. They will be archived to history once the next evaluation period is released.
                            </p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    /* Dropdown styling */
    .dropdown-toggle::after {
        margin-left: 0.5rem;
    }
    
    .period-result-option {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .period-result-option:hover {
        background-color: #e8f5e8;
        color: #47682c !important;
        transform: translateX(4px);
    }
</style>

<script>
    // Handle period-specific result type selection
    document.addEventListener('DOMContentLoaded', function() {
        // Setup click handlers for all period result options
        const resultOptions = document.querySelectorAll('.period-result-option');
        
        resultOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                
                const resultType = this.getAttribute('data-result-type');
                const sectionId = this.getAttribute('data-section-id');
                const sectionName = this.getAttribute('data-section-name');
                const timelineItem = this.closest('.timeline-item');
                const periodCard = timelineItem.querySelector('.period-card');
                
                console.log(`Selected ${resultType}` + (sectionName ? ` - ${sectionName}` : ''));
                
                // Update the period-specific display based on result type
                handlePeriodResultSelection(resultType, periodCard, sectionName, sectionId);
            });
        });
    });
    
    // Handle the selected result type for a specific period
    function handlePeriodResultSelection(resultType, periodCard, sectionName, sectionId) {
        // Extract period information
        const periodName = periodCard.querySelector('.period-title')?.textContent || 'Period';
        const categoryScores = Array.from(periodCard.querySelectorAll('.category-score'))
            .map(el => parseFloat(el.textContent));
        const overallPercentage = periodCard.querySelector('.score-badge')?.textContent || 'N/A';
        
        console.log(`Handling ${resultType} selection for ${periodName}`);
        if (sectionName) {
            console.log(`Section: ${sectionName}`);
        }
        
        // Highlight or expand the selected result type
        const button = periodCard.querySelector('.dropdown .btn');
        let buttonText = {
            'overall': 'üìà Overall',
            'peer': 'üë• Peer Results'
        }[resultType];
        
        // If section result, use section name
        if (resultType === 'section' && sectionName) {
            buttonText = `üìö ${sectionName}`;
        }
        
        button.textContent = buttonText + ' ';
        const caret = document.createElement('i');
        caret.className = 'fas fa-chevron-down';
        button.appendChild(caret);
        
        // Show a subtle indicator that this result type is being viewed
        const periodContent = periodCard.querySelector('.period-content');
        if (periodContent) {
            periodContent.style.borderTop = '3px solid #47682c';
            periodContent.style.paddingTop = '15px';
            periodContent.style.marginTop = '10px';
        }
        
        // Log the action
        console.log(`Now viewing ${resultType}${sectionName ? ` (${sectionName})` : ''} results for ${periodName}`);
    }
</script>

{% endblock %}