{% extends 'main/base.html' %}

{% block content %}
<style>
    .container {
        padding: 30px 20px;
        background-color: #f8fafc;
    }

    #coordinator-header h3 {
        font-size: 2.2rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
    }

    #coordinator-header p {
        color: #4a5568;
        margin-bottom: 6px;
        font-size: 1.1rem;
    }

    .card {
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        background-color: white;
        margin-bottom: 20px;
        border: none;
        transition: transform 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
    }

    .card-body {
        padding: 20px;
    }

    .some-specific-dropdown .dropdown-toggle {
        background: linear-gradient(135deg, #576d2e, #6b8c3a);
        color: white;
        border-radius: 25px;
        padding: 10px 20px;
        font-size: 0.95rem;
        border: none;
        box-shadow: 0 2px 8px rgba(87, 109, 46, 0.3);
        transition: all 0.3s ease;
    }

    .some-specific-dropdown .dropdown-toggle:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(87, 109, 46, 0.4);
    }

    .dropdown-menu {
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        border: none;
        padding: 8px 0;
    }

    .dropdown-item {
        padding: 10px 20px;
        font-size: 1rem;
        transition: background-color 0.2s ease;
    }

    .dropdown-item:hover {
        background-color: #f7fafc;
        color: #576d2e;
    }

    .dropdown-divider {
        margin: 5px 0;
        border-color: #e2e8f0;
    }

    .overall-option {
        background: linear-gradient(135deg, #f7fafc, #edf2f7);
        border-top: 2px solid #e2e8f0;
        font-weight: 600;
        color: #2d3748 !important;
    }

    .overall-option:hover {
        background: linear-gradient(135deg, #576d2e, #6b8c3a) !important;
        color: white !important;
    }

    .peer-option, .irregular-option, .upward-option, .student-upward-option {
        background: linear-gradient(135deg, #f7fafc, #edf2f7);
        font-weight: 600;
        color: #2d3748 !important;
    }

    .peer-option:hover, .irregular-option:hover, .upward-option:hover, .student-upward-option:hover {
        background: linear-gradient(135deg, #576d2e, #6b8c3a) !important;
        color: white !important;
    }

    .section-box {
        background: white;
        display: none;
        opacity: 0;
        transition: opacity 0.4s ease-in-out;
        padding: 30px;
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        margin: 20px 0;
    }

    .section-box h3 {
        margin-bottom: 25px;
        font-size: 1.6rem;
        font-weight: 600;
        color: #2d3748;
        background: linear-gradient(135deg, #576d2e, #4a5a26);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .overall-badge {
        background: linear-gradient(135deg, #576d2e, #6b8c3a);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-left: 8px;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        align-items: start;
        max-width: 900px;
        margin: 0 auto;
    }

    .chart-container {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }

    .scores-container {
        background: #f8fafc;
        border-radius: 12px;
        padding: 25px;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }

    .score-breakdown {
        text-align: left;
    }

    .score-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #e2e8f0;
        transition: background-color 0.2s ease;
    }

    .score-item:hover {
        background-color: rgba(255,255,255,0.5);
        border-radius: 8px;
        padding: 15px 10px;
    }

    .score-item:last-child {
        border-bottom: none;
        font-weight: 700;
        font-size: 1.1rem;
        color: #2d3748;
        background: linear-gradient(135deg, #576d2e, #6b8c3a);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-top: 10px;
        padding-top: 20px;
        border-top: 2px solid #e2e8f0;
    }

    .score-category {
        font-weight: 600;
        color: #4a5568;
        font-size: 1.05rem;
    }

    .score-value {
        font-weight: 700;
        color: #2d3748;
        font-size: 1.25rem;
        background: white;
        padding: 6px 12px;
        border-radius: 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        min-width: 70px;
        text-align: center;
    }

    .score-item:last-child .score-value {
        background: linear-gradient(135deg, #576d2e, #6b8c3a);
        color: white;
        -webkit-text-fill-color: white;
        box-shadow: 0 3px 10px rgba(87, 109, 46, 0.3);
    }

    #evaluationPieChart {
        width: 100% !important;
        height: 280px !important;
    }

    .no-data-state {
        text-align: center;
        padding: 40px 20px;
        color: #718096;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .no-data-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    .explanation-box {
        background: linear-gradient(135deg, #f7fafc, #edf2f7);
        border-radius: 12px;
        padding: 25px;
        margin: 25px 0;
        border-left: 4px solid #576d2e;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .explanation-box h5 {
        color: #576d2e;
        font-weight: 600;
        margin-bottom: 15px;
        font-size: 1.25rem;
    }

    .explanation-content {
        font-size: 1.05rem;
        color: #4a5568;
        line-height: 1.6;
    }

    .explanation-content ul {
        margin: 10px 0;
        padding-left: 20px;
    }

    .explanation-content li {
        margin-bottom: 5px;
    }

    .stats-summary {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .stat-item {
        background: white;
        padding: 12px 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
        min-width: 120px;
    }

    .stat-value {
        font-size: 1.4rem;
        font-weight: 700;
        color: #576d2e;
        display: block;
    }

    .stat-label {
        font-size: 0.95rem;
        color: #718096;
        margin-top: 4px;
    }

    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .container {
            padding: 20px 15px;
        }
        
        .section-box {
            padding: 20px 15px;
        }
        
        #evaluationPieChart {
            height: 250px !important;
        }
        
        .stats-summary {
            gap: 10px;
        }
        
        .stat-item {
            min-width: 100px;
            padding: 10px 15px;
        }

        #coordinator-header h3 {
            font-size: 1.8rem;
        }

        #coordinator-header p {
            font-size: 1rem;
        }

        .score-category {
            font-size: 1rem;
        }

        .score-value {
            font-size: 1.1rem;
        }

        .section-box h3 {
            font-size: 1.4rem;
        }
    }

    @media (max-width: 480px) {
        #coordinator-header h3 {
            font-size: 1.6rem;
        }

        #coordinator-header p {
            font-size: 0.95rem;
        }
        
        .score-value {
            font-size: 1.05rem;
            min-width: 60px;
            padding: 5px 10px;
        }

        .score-category {
            font-size: 0.95rem;
        }
        
        .section-box h3 {
            font-size: 1.3rem;
        }

        .explanation-box h5 {
            font-size: 1.1rem;
        }

        .explanation-content {
            font-size: 0.95rem;
        }

        .dropdown-item {
            font-size: 0.95rem;
        }

        .stat-label {
            font-size: 0.85rem;
        }
    }
</style>

<div class="container mt-4">
    <!-- Success/Error Messages -->
    {% if messages %}
        <div class="row justify-content-center mb-3">
            <div class="col-lg-10">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show flash-message" role="alert" style="border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <strong>{% if message.tags == 'success' %}‚úÖ{% elif message.tags == 'error' %}‚ùå{% elif message.tags == 'warning' %}‚ö†Ô∏è{% else %}‚ÑπÔ∏è{% endif %}</strong> {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- Coordinator Header -->
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="text-start" id="coordinator-header">
                <h3 class="mb-2">{{ coordinator.user.username }}</h3>   
                <p class="fs-6 mb-1">
                    {% if coordinator.institute == "IBM" %}
                        Institute of Business and Management
                    {% elif coordinator.institute == "ICSLIS" %}
                        Institute of Computing Studies and Library Information Science
                    {% elif coordinator.institute == "IEAS" %}
                        Institute of Education, Arts and Services
                    {% else %}
                        {{ coordinator.institute }}
                    {% endif %}
                </p>     
                <p class="fs-7 text-muted">{{ coordinator.role }}</p>
                {% if assigned_sections %}
                    <div class="mt-3">
                        <strong>Assigned Sections:</strong>
                        <div class="mt-2">
                            {% for assignment in assigned_sections %}
                                <span class="badge bg-success me-1 mb-1">{{ assignment.section.code }}</span>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}  
            </div>
        </div>
    </div>

    <!-- Section Assignment Management (Only visible to Dean/Coordinator with edit permission) -->
    {% if can_edit_sections %}
    <div class="card shadow-sm border-0 mt-4">
        <div class="card-body">
            <h4 class="text-center" style="color: #576d2e; font-weight: 600; margin-bottom: 20px;">
                ‚öôÔ∏è Manage Section Assignments
            </h4>
            
            <form method="POST" action="">
                {% csrf_token %}
                <input type="hidden" name="action" value="assign_sections">
                
                <!-- Simple instructions -->
                <div class="alert alert-info">
                    <strong>üìã How to manage sections:</strong><br>
                    ‚Ä¢ <strong>Check</strong> = Assign section to this {{ coordinator.role }}<br>
                    ‚Ä¢ <strong>Uncheck</strong> = Remove section from this {{ coordinator.role }}<br>
                    ‚Ä¢ To remove <strong>ALL</strong> sections: Uncheck EVERY box below
                </div>

                <!-- Current assignments summary -->
                <div class="mb-4" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h5 style="color: #576d2e;">üìä Currently Assigned ({{ assigned_sections|length }} sections):</h5>
                    {% if assigned_sections %}
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                            {% for assignment in assigned_sections %}
                            <span style="background-color: #28a745; color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem;">
                                {{ assignment.section.code }} ({{ assignment.section.get_year_level_display }} Year)
                            </span>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div style="color: #666; font-style: italic; margin-top: 10px;">No sections currently assigned</div>
                    {% endif %}
                </div>

                <!-- Year filter -->
                <div class="form-group mb-3">
                    <label for="year_filter" style="font-weight: 600; color: #576d2e;">üîç Filter by Year Level:</label>
                    <select id="year_filter" class="form-control" style="border-radius: 8px;">
                        <option value="">-- Show All Years --</option>
                        {% for year in years %}
                            <option value="{{ year }}">{{ year }} Year</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Section selection -->
                <div class="form-group">
                    <label style="font-weight: 600; color: #576d2e;">‚úÖ Section Selection:</label>
                    <div class="section-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9;">
                        {% for section in sections %}
                        <div class="form-check mb-2" data-year="{{ section.year_level }}">
                            <input class="form-check-input" type="checkbox" name="sections" 
                                   value="{{ section.id }}" 
                                   id="section_{{ section.id }}"
                                   {% if section.id in currently_assigned_ids %}checked{% endif %}>
                            <label class="form-check-label" for="section_{{ section.id }}">
                                <strong>{{ section.code }}</strong> - {{ section.get_year_level_display }} Year
                                {% if section.id in currently_assigned_ids %}
                                <span style="color: #576d2e; font-weight: bold;">‚úì (Currently Assigned)</span>
                                {% endif %}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    <small class="text-muted">
                        <strong>Tip:</strong> Use the year filter above to find sections faster
                    </small>
                </div>

                <button type="submit" class="btn btn-success w-100 fw-bold mt-3" style="background: linear-gradient(135deg, #576d2e, #6b8c3a); border: none; border-radius: 25px; padding: 12px;">
                    üíæ Save Section Assignments
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Section Dropdown -->
    <div class="mt-4">
        <div class="some-specific-dropdown">
            <button class="btn dropdown-toggle" type="button" id="sectionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                üìä Select Section
            </button>
            <ul class="dropdown-menu" aria-labelledby="sectionDropdown">
                <!-- Overall Option -->
                <li><a class="dropdown-item overall-option" href="#" data-section="overall" data-type="student">
                    üìà Overall Results 
                    <span class="overall-badge">All Sections</span>
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Individual Sections -->
                {% for assignment in assigned_sections %}
                    <li><a class="dropdown-item section-item" 
                        data-section="{{ assignment.section.id }}" 
                        data-section-display="{{ assignment.section }}" 
                        data-type="student"
                        href="#">
                        üìö {{ assignment.section }}
                    </a></li>
                {% empty %}
                    <li><a class="dropdown-item text-muted" href="#">No sections assigned</a></li>
                {% endfor %}
                <li><hr class="dropdown-divider"></li>
                <!-- Student to Coordinator Evaluation Results -->
                <li><a class="dropdown-item student-upward-option" href="#" data-section="student-upward" data-type="student-upward">
                    üìù Student to Coordinator Results
                    <span class="overall-badge">Student ‚Üí Coordinator</span>
                </a></li>
                <!-- Upward Evaluation Results -->
                <li><a class="dropdown-item upward-option" href="#" data-section="upward" data-type="upward">
                    üéØ Upward Evaluation Results
                    <span class="overall-badge">Faculty ‚Üí Coordinator</span>
                </a></li>
                <!-- Peer Evaluation Results -->
                <li><a class="dropdown-item peer-option" href="#" data-section="peer" data-type="peer">
                    üë• Peer Evaluation Results
                    <span class="overall-badge">Faculty Peers</span>
                </a></li>
                <!-- Irregular Evaluation Results -->
                <li><a class="dropdown-item irregular-option" href="#" data-section="irregular" data-type="irregular">
                    üîÑ Irregular Student Results
                    <span class="overall-badge">Irregular Students</span>
                </a></li>
            </ul>
        </div>
    </div>

    <!-- Section Results Container -->
    <div class="section-box mt-4">
        <h3 id="sectionTitle">Select a section to view evaluation results</h3>
        
        <!-- Overall Stats Summary (Only shown for overall view) -->
        <div id="overallStats" class="stats-summary" style="display: none;">
            <div class="stat-item">
                <span class="stat-value" id="totalSections">0</span>
                <span class="stat-label">Total Sections</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="sectionsWithData">0</span>
                <span class="stat-label">Sections with Data</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="totalEvaluations">0</span>
                <span class="stat-label">Total Evaluations</span>
            </div>
        </div>
        
        <!-- Upward Evaluation Simple Display -->
        <div id="upwardDisplay" style="display: none; text-align: center; padding: 40px; background: #f8fafc; border-radius: 12px; margin: 20px 0;">
            <h4 style="color: #576d2e; margin-bottom: 20px;">üéØ Upward Evaluation Score</h4>
            <div style="font-size: 72px; font-weight: bold; color: #576d2e;" id="upwardTotalScore">0%</div>
            <div style="font-size: 24px; font-weight: 600; margin-top: 10px;" id="upwardRatingDescriptor"></div>
            <p style="color: #718096; margin-top: 15px; font-size: 1.1rem;">Average score from faculty evaluations (15 questions)</p>
            <p style="color: #4a5568; margin-top: 10px;"><strong>Total Evaluations:</strong> <span id="upwardEvaluationCount">0</span></p>
        </div>
        
        <!-- Peer Evaluation Simple Display -->
        <div id="peerDisplay" style="display: none; text-align: center; padding: 40px; background: #f8fafc; border-radius: 12px; margin: 20px 0;">
            <h4 style="color: #576d2e; margin-bottom: 20px;">üë• Peer Evaluation Average Score</h4>
            <div style="font-size: 72px; font-weight: bold; color: #576d2e;" id="peerTotalScore">0%</div>
            <div style="font-size: 24px; font-weight: 600; margin-top: 10px;" id="peerRatingDescriptor"></div>
            <p style="color: #718096; margin-top: 15px; font-size: 1.1rem;">Simple average of all 15 peer evaluation questions</p>
            <p style="color: #4a5568; margin-top: 10px;"><strong>Total Evaluations:</strong> <span id="peerEvaluationCount">0</span></p>
        </div>

        <div class="dashboard-grid">
            <div class="chart-container">
                <canvas id="evaluationPieChart"></canvas>
            </div>
            
            <div id="scoreDetails" class="score-breakdown" style="display: none;">
                <div class="score-item">
                    <span class="score-category">Mastery of Subject Matter</span>
                    <span class="score-value" id="scoreA">0%</span>
                </div>
                <div class="score-item">
                    <span class="score-category">Classroom Management</span>
                    <span class="score-value" id="scoreB">0%</span>
                </div>
                <div class="score-item">
                    <span class="score-category">Compliance to policies</span>
                    <span class="score-value" id="scoreC">0%</span>
                </div>
                <div class="score-item">
                    <span class="score-category">Personality</span>
                    <span class="score-value" id="scoreD">0%</span>
                </div>
                <div class="score-item">
                    <span>Total Score</span>
                    <span class="score-value" id="totalScore">0%</span>
                </div>
                <div style="text-align: center; margin-top: 15px; font-size: 20px; font-weight: 600;" id="totalRatingDescriptor"></div>
            </div>
                
            <div id="noDataMessage" class="no-data-state" style="display: none;">
                <div style="font-size: 4rem; margin-bottom: 20px;">üìä</div>
                <p style="color: #2d3748; font-size: 1.3rem; margin: 10px 0 0 0; font-weight: 600;">
                    No evaluation results yet.
                </p>
                <p style="color: #718096; font-size: 1rem; margin: 10px 0 0 0;">
                    Evaluation data will appear here once submissions are available.
                </p>
            </div>
        </div>
    </div>

    <!-- Explanation Box -->
    <div class="explanation-box" style="display: none;" id="explanationBox">
        <h5>üìù How Evaluation Scores Are Calculated</h5>
        <div class="explanation-content">
            <p>The evaluation is divided into four weighted categories:</p>
            <ul>
                <li><strong>Mastery of Subject Matter</strong>: Questions 1-4 (35% weight)</li>
                <li><strong>Classroom Management</strong>: Questions 5-8 (25% weight)</li>
                <li><strong>Compliance to Policies</strong>: Questions 9-12 (20% weight)</li>
                <li><strong>Personality</strong>: Questions 13-15 (20% weight)</li>
            </ul>
            <p>Responses are rated on a 5-point scale (5=Outstanding, 1=Poor) and converted to percentages based on category weights.</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let chart = null;
    
    // Get data from Django template
    const sectionScores = JSON.parse('{{ section_scores_json|escapejs }}');
    const sectionMap = JSON.parse('{{ section_map_json|escapejs }}');
    const peerData = JSON.parse('{{ peer_data_json|escapejs }}');
    const irregularData = JSON.parse('{{ irregular_data_json|escapejs }}');
    const upwardData = JSON.parse('{{ upward_data_json|escapejs }}');
    const studentUpwardData = JSON.parse('{{ student_upward_data_json|escapejs }}');
    
    console.log("Section Scores:", sectionScores);
    console.log("Section Map:", sectionMap);
    console.log("Peer Data:", peerData);
    console.log("Irregular Data:", irregularData);
    console.log("Upward Data:", upwardData);
    console.log("Student Upward Data:", studentUpwardData);

    // Function to get rating descriptor based on percentage
    function getRatingDescriptor(percentage) {
        if (percentage >= 90) return { text: 'Excellent', color: '#10b981' };
        if (percentage >= 80) return { text: 'Very Satisfactory', color: '#3b82f6' };
        if (percentage >= 70) return { text: 'Satisfactory', color: '#f59e0b' };
        if (percentage >= 60) return { text: 'Fair', color: '#ef4444' };
        return { text: 'Needs Improvement', color: '#dc2626' };
    }

    function calculateOverallResults() {
        console.log("Calculating overall results...");
        
        let totalSections = 0;
        let sectionsWithData = 0;
        let totalEvaluations = 0;
        
        // Initialize arrays to accumulate scores
        let categoryScoresSum = [0, 0, 0, 0]; // For 4 categories
        let totalPercentageSum = 0;
        
        // Iterate through all sections
        for (const [sectionCode, sectionData] of Object.entries(sectionScores)) {
            totalSections++;
            
            if (sectionData && sectionData.has_data) {
                sectionsWithData++;
                totalEvaluations += sectionData.evaluation_count || 0;
                
                // Accumulate category scores
                for (let i = 0; i < 4; i++) {
                    categoryScoresSum[i] += sectionData.category_scores[i] || 0;
                }
                
                // Accumulate total percentage
                totalPercentageSum += sectionData.total_percentage || 0;
            }
        }
        
        // Calculate averages
        const averageCategoryScores = sectionsWithData > 0 
            ? categoryScoresSum.map(score => score / sectionsWithData)
            : [0, 0, 0, 0];
            
        const averageTotalPercentage = sectionsWithData > 0 
            ? totalPercentageSum / sectionsWithData 
            : 0;
        
        return {
            has_data: sectionsWithData > 0,
            total_sections: totalSections,
            sections_with_data: sectionsWithData,
            total_evaluations: totalEvaluations,
            category_scores: averageCategoryScores,
            total_percentage: averageTotalPercentage
        };
    }

    function renderPieChart(sectionId, dataType = 'student') {
        console.log("Rendering chart for:", sectionId, "Type:", dataType);
        
        const ctx = document.getElementById('evaluationPieChart').getContext('2d');
        
        // Destroy previous chart
        if (chart) {
            chart.destroy();
        }

        let sectionData;
        let isOverall = false;
        
        if (dataType === 'peer') {
            // Peer evaluation results
            sectionData = peerData;
            console.log("Peer data:", sectionData);
            document.getElementById('overallStats').style.display = 'none';
        } else if (dataType === 'student-upward') {
            // Student to Coordinator evaluation results
            sectionData = studentUpwardData;
            console.log("Student Upward data:", sectionData);
            document.getElementById('overallStats').style.display = 'none';
        } else if (dataType === 'upward') {
            // Upward evaluation results (Faculty ‚Üí Coordinator)
            sectionData = upwardData;
            console.log("Upward data:", sectionData);
            document.getElementById('overallStats').style.display = 'none';
        } else if (dataType === 'irregular') {
            // Irregular evaluation results
            sectionData = irregularData;
            console.log("Irregular data:", sectionData);
            document.getElementById('overallStats').style.display = 'none';
        } else if (sectionId === 'overall') {
            // Calculate overall results
            sectionData = calculateOverallResults();
            console.log("Overall data:", sectionData);
            isOverall = true;
            
            // Show overall stats
            document.getElementById('overallStats').style.display = 'flex';
            document.getElementById('totalSections').textContent = sectionData.total_sections;
            document.getElementById('sectionsWithData').textContent = sectionData.sections_with_data;
            document.getElementById('totalEvaluations').textContent = sectionData.total_evaluations;
        } else {
            // Individual section
            const sectionCode = sectionMap[sectionId];
            sectionData = sectionScores[sectionCode];
            console.log("Individual section data:", sectionData);
            
            // Hide overall stats
            document.getElementById('overallStats').style.display = 'none';
        }

        console.log("Section data retrieved:", sectionData);
        console.log("Has data check:", sectionData && sectionData.has_data);
        
        if (sectionData && sectionData.has_data) {
            console.log("Has data, rendering chart");
            renderChartWithData(ctx, sectionData, isOverall, dataType);
        } else {
            console.log("No data available, calling showNoData()");
            showNoData();
        }
    }

    function renderChartWithData(ctx, sectionData, isOverall = false, dataType = 'student') {
        const categoryScores = sectionData.category_scores;
        const totalPercentage = sectionData.total_percentage;

        console.log("Rendering with scores:", categoryScores, "Total:", totalPercentage);

        // For peer evaluations, only show total score (no categories)
        if (dataType === 'peer') {
            // Check if there's data
            if (!sectionData.has_data || totalPercentage === 0) {
                // Show no data message for peer evaluation
                showNoData();
                return;
            }
            
            // Hide chart and category breakdown
            document.getElementById('evaluationPieChart').style.display = 'none';
            document.getElementById('scoreDetails').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('explanationBox').style.display = 'none';
            document.querySelector('.dashboard-grid').style.display = 'none';
            
            // Hide upward display, show peer display
            document.getElementById('upwardDisplay').style.display = 'none';
            const peerDisplay = document.getElementById('peerDisplay');
            peerDisplay.style.display = 'block';
            document.getElementById('peerTotalScore').textContent = totalPercentage.toFixed(1) + '%';
            document.getElementById('peerEvaluationCount').textContent = sectionData.evaluation_count || 0;
            
            // Add rating descriptor
            const peerRating = getRatingDescriptor(totalPercentage);
            const peerDescriptor = document.getElementById('peerRatingDescriptor');
            peerDescriptor.textContent = peerRating.text;
            peerDescriptor.style.color = peerRating.color;
            return;
        }
        
        // For student upward evaluations, only show total score (no categories)
        if (dataType === 'student-upward') {
            // Check if there's data
            if (!sectionData.has_data || totalPercentage === 0) {
                // Show no data message for student upward evaluation
                showNoData();
                return;
            }
            
            // Hide chart and category breakdown
            document.getElementById('evaluationPieChart').style.display = 'none';
            document.getElementById('scoreDetails').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('explanationBox').style.display = 'none';
            document.querySelector('.dashboard-grid').style.display = 'none';
            
            // Hide peer and upward displays, show student upward display
            document.getElementById('peerDisplay').style.display = 'none';
            document.getElementById('upwardDisplay').style.display = 'none';
            const studentUpwardDisplay = document.getElementById('studentUpwardDisplay');
            studentUpwardDisplay.style.display = 'block';
            document.getElementById('studentUpwardTotalScore').textContent = totalPercentage.toFixed(1) + '%';
            document.getElementById('studentUpwardEvaluationCount').textContent = sectionData.evaluation_count || 0;
            
            // Add rating descriptor
            const studentUpwardRating = getRatingDescriptor(totalPercentage);
            const studentUpwardDescriptor = document.getElementById('studentUpwardRatingDescriptor');
            studentUpwardDescriptor.textContent = studentUpwardRating.text;
            studentUpwardDescriptor.style.color = studentUpwardRating.color;
            return;
        }
        
        // For upward evaluations, only show total score (no categories)
        if (dataType === 'upward') {
            // Check if there's data
            if (!sectionData.has_data || totalPercentage === 0) {
                // Show no data message for upward evaluation
                showNoData();
                return;
            }
            
            // Hide chart and category breakdown
            document.getElementById('evaluationPieChart').style.display = 'none';
            document.getElementById('scoreDetails').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('explanationBox').style.display = 'none';
            document.querySelector('.dashboard-grid').style.display = 'none';
            
            // Hide peer and student upward displays, show upward display
            document.getElementById('peerDisplay').style.display = 'none';
            document.getElementById('studentUpwardDisplay').style.display = 'none';
            const upwardDisplay = document.getElementById('upwardDisplay');
            upwardDisplay.style.display = 'block';
            document.getElementById('upwardTotalScore').textContent = totalPercentage.toFixed(1) + '%';
            document.getElementById('upwardEvaluationCount').textContent = sectionData.evaluation_count || 0;
            
            // Add rating descriptor
            const upwardRating = getRatingDescriptor(totalPercentage);
            const upwardDescriptor = document.getElementById('upwardRatingDescriptor');
            upwardDescriptor.textContent = upwardRating.text;
            upwardDescriptor.style.color = upwardRating.color;
            return;
        }
        
        // For non-peer/non-upward/non-student-upward evaluations, show dashboard grid
        document.querySelector('.dashboard-grid').style.display = 'grid';
        document.getElementById('peerDisplay').style.display = 'none';
        document.getElementById('upwardDisplay').style.display = 'none';
        document.getElementById('studentUpwardDisplay').style.display = 'none';

        // Update score details for ALL 4 CATEGORIES (student and irregular only)
        document.getElementById('scoreA').textContent = categoryScores[0].toFixed(1) + '%';
        document.getElementById('scoreB').textContent = categoryScores[1].toFixed(1) + '%';
        document.getElementById('scoreC').textContent = categoryScores[2].toFixed(1) + '%';
        document.getElementById('scoreD').textContent = categoryScores[3].toFixed(1) + '%';
        document.getElementById('totalScore').textContent = totalPercentage.toFixed(1) + '%';
        
        // Add rating descriptor for total score
        const totalRating = getRatingDescriptor(totalPercentage);
        const totalDescriptor = document.getElementById('totalRatingDescriptor');
        totalDescriptor.textContent = totalRating.text;
        totalDescriptor.style.color = totalRating.color;

        // Show elements
        document.getElementById('scoreDetails').style.display = 'block';
        document.getElementById('noDataMessage').style.display = 'none';
        document.getElementById('explanationBox').style.display = 'block';

        // Show canvas for non-peer evaluations
        const canvas = document.getElementById('evaluationPieChart');
        canvas.style.display = 'block';

        // Chart labels based on type
        let labels;
        if (dataType === 'peer') {
            // Peer evaluations don't have categories, skip chart
            return;
        } else if (dataType === 'irregular') {
            labels = ['Irregular: Subject Mastery', 'Irregular: Classroom Management', 'Irregular: Compliance', 'Irregular: Personality'];
        } else if (isOverall) {
            labels = ['Overall Subject Mastery', 'Overall Classroom Management', 'Overall Compliance', 'Overall Personality'];
        } else {
            labels = ['Subject Mastery', 'Classroom Management', 'Compliance to Policies', 'Personality'];
        }

        // Create enhanced chart with 4 CATEGORIES
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: categoryScores,
                    backgroundColor: [
                        'rgba(87, 109, 46, 0.8)',
                        'rgba(106, 140, 58, 0.8)',
                        'rgba(135, 171, 70, 0.8)',
                        'rgba(164, 202, 82, 0.8)'
                    ],
                    borderColor: [
                        'rgba(87, 109, 46, 1)',
                        'rgba(106, 140, 58, 1)',
                        'rgba(135, 171, 70, 1)',
                        'rgba(164, 202, 82, 1)'
                    ],
                    borderWidth: 2,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: 11,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(45, 55, 72, 0.9)',
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw.toFixed(1)}%`;
                            }
                        }
                    }
                },
                animation: {
                    animateScale: true,
                    animateRotate: true
                }
            }
        });
        
        console.log("Chart rendered successfully!");
    }

    function showNoData() {
        console.log("showNoData called - displaying no data message");
        const sectionBox = document.querySelector('.section-box');
        const noDataMsg = document.getElementById('noDataMessage');
        
        console.log("Section box element:", sectionBox);
        console.log("No data message element:", noDataMsg);
        
        if (sectionBox) {
            sectionBox.style.display = 'block';
            sectionBox.style.opacity = '1';
            console.log("Section box made visible");
        }
        
        const dashboardGrid = document.querySelector('.dashboard-grid');
        if (dashboardGrid) dashboardGrid.style.display = 'none';
        
        const scoreDetails = document.getElementById('scoreDetails');
        if (scoreDetails) scoreDetails.style.display = 'none';
        
        if (noDataMsg) {
            noDataMsg.style.display = 'block';
            console.log("No data message made visible");
        }
        
        const explanationBox = document.getElementById('explanationBox');
        if (explanationBox) explanationBox.style.display = 'none';
        
        const overallStats = document.getElementById('overallStats');
        if (overallStats) overallStats.style.display = 'none';
        
        const peerDisplay = document.getElementById('peerDisplay');
        if (peerDisplay) peerDisplay.style.display = 'none';
        
        const upwardDisplay = document.getElementById('upwardDisplay');
        if (upwardDisplay) upwardDisplay.style.display = 'none';
        
        const studentUpwardDisplay = document.getElementById('studentUpwardDisplay');
        if (studentUpwardDisplay) studentUpwardDisplay.style.display = 'none';
    }

    // Section dropdown event listeners
    document.querySelectorAll('.section-item, .overall-option, .peer-option, .irregular-option, .upward-option, .student-upward-option').forEach(item => {
        item.addEventListener('click', function (e) {
            e.preventDefault();
            
            const sectionId = this.getAttribute('data-section');
            const dataType = this.getAttribute('data-type') || 'student';
            const displayName = this.getAttribute('data-section-display') || 
                               (sectionId === 'overall' ? 'Overall Results' : 
                                sectionId === 'peer' ? 'Peer Evaluation Results' : 
                                sectionId === 'student-upward' ? 'Student to Coordinator Results' :
                                sectionId === 'upward' ? 'Upward Evaluation Results' :
                                sectionId === 'irregular' ? 'Irregular Student Results' : 'Results');
            
            console.log("Clicked:", sectionId, "Type:", dataType, "Display:", displayName);
            
            // Update dropdown text
            if (sectionId === 'overall') {
                document.getElementById('sectionDropdown').textContent = 'üìà Overall Results';
            } else if (sectionId === 'peer') {
                document.getElementById('sectionDropdown').textContent = 'üë• Peer Evaluation Results';
            } else if (sectionId === 'student-upward') {
                document.getElementById('sectionDropdown').textContent = 'üìù Student to Coordinator Results';
            } else if (sectionId === 'upward') {
                document.getElementById('sectionDropdown').textContent = 'üéØ Upward Evaluation Results';
            } else if (sectionId === 'irregular') {
                document.getElementById('sectionDropdown').textContent = 'üîÑ Irregular Student Results';
            } else {
                document.getElementById('sectionDropdown').textContent = 'üìö ' + displayName;
            }
            
            document.getElementById('sectionTitle').textContent = displayName + ' - Evaluation Results';

            const sectionBox = document.querySelector('.section-box');
            sectionBox.style.opacity = '0';
            
            setTimeout(() => {
                sectionBox.style.display = 'block';
                renderPieChart(sectionId, dataType);
                setTimeout(() => {
                    sectionBox.style.opacity = '1';
                }, 10);
            }, 300);
        });
    });

    // Initialize - click overall option first if available
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Page loaded, checking for sections...");
        const overallOption = document.querySelector('.overall-option');
        if (overallOption) {
            console.log("Clicking overall option...");
            overallOption.click();
        } else {
            console.log("No overall option available");
            const firstSection = document.querySelector('.section-item');
            if (firstSection) {
                firstSection.click();
            } else {
                showNoData();
            }
        }
        
        // Year filter functionality for section assignment
        const yearFilter = document.getElementById('year_filter');
        if (yearFilter) {
            yearFilter.addEventListener('change', function() {
                const selectedYear = this.value;
                const sectionItems = document.querySelectorAll('.section-list .form-check');
                
                sectionItems.forEach(item => {
                    const itemYear = item.getAttribute('data-year');
                    if (!selectedYear || String(itemYear) === String(selectedYear)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }
    });
    
    // Auto-dismiss flash messages after 5 seconds
    document.addEventListener('DOMContentLoaded', function() {
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(flash => {
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(flash);
                bsAlert.close();
            }, 5000);
        });
    });
</script>

{% endblock %}